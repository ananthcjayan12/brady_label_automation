{% extends 'base.html' %}
{% load static %}

{% block title %}Second Stage{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="text-center mb-6">
        <img class="h-12 w-auto mx-auto" src="{% static 'img/logo.png' %}" alt="Your Company Logo">
    </div>
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Second Stage Label Generation</h1>
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:p-6">
            <form id="barcode-form" class="space-y-6">
                <div>
                    <label for="barcode-input" class="block text-sm font-medium text-gray-700">Scan Barcode</label>
                    <div class="mt-1 relative rounded-md shadow-sm border border-gray-300 focus-within:ring-1 focus-within:ring-primary focus-within:border-primary">
                        <input type="text" name="barcode" id="barcode-input" class="block w-full pr-10 sm:text-sm rounded-md focus:outline-none" placeholder="Scan or enter barcode">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm2 2V5h1v1H5zM3 13a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1v-3zm2 2v-1h1v1H5zM13 3a1 1 0 00-1 1v3a1 1 0 001 1h3a1 1 0 001-1V4a1 1 0 00-1-1h-3zm1 2v1h1V5h-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div>
                    <button type="submit" id="generate-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Generate Label
                    </button>
                </div>
            </form>

            <div id="result-container" class="mt-8 hidden">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Generated Label</h2>
                <div class="bg-gray-100 p-4 rounded-md mb-4 border border-gray-300">
                    <p class="text-sm text-gray-600">Serial Number: <span id="serial-number" class="font-medium text-gray-900"></span></p>
                    <p class="text-sm text-gray-600 mt-2">IMEI: <span id="imei-number" class="font-medium text-gray-900"></span></p>
                </div>
                <div class="flex justify-between">
                    <button id="print-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Print Label
                    </button>
                    <button id="preview-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-secondary hover:bg-secondary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary">
                        Preview Label
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Label Preview -->
<div class="fixed z-10 inset-0 overflow-y-auto hidden" id="labelPreviewModal">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Label Preview</h3>
                        <div class="mt-2">
                            <embed id="labelPreviewEmbed" src="" type="application/pdf" width="100%" height="600px" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" id="closeModal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        let generatedPdfData = null;

        $('#barcode-form').submit(function(e) {
            e.preventDefault();
            var barcode = $('#barcode-input').val();
            if (barcode) {
                $.post('/process-barcode/', {
                    barcode: barcode,
                    stage: 'second-stage',
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }, function(data) {
                    if (data.success) {
                        $('#serial-number').text(data.serial_number);
                        $('#imei-number').text(data.imei_number);
                        $('#result-container').removeClass('hidden');
                        generatedPdfData = data.label_pdf;
                        
                        // Show PDF preview
                        $('#labelPreviewEmbed').attr('src', generatedPdfData);
                        $('#labelPreviewModal').removeClass('hidden');
                    } else {
                        alert('Error generating label: ' + data.error);
                    }
                });
            } else {
                alert('Please enter a barcode');
            }
        });

        $('#print-btn').click(function() {
            var barcode = $('#barcode-input').val();
            $.post('/process-barcode/', {
                barcode: barcode,
                stage: 'second-stage',
                print: true,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }, function(data) {
                if (data.print_success) {
                    alert('Label printed successfully');
                } else {
                    alert('Error printing label: ' + data.print_message);
                }
            });
        });

        $('#preview-btn').click(function() {
            if (generatedPdfData) {
                $('#labelPreviewEmbed').attr('src', generatedPdfData);
                $('#labelPreviewModal').removeClass('hidden');
            } else {
                alert('Please generate a label first');
            }
        });

        $('#closeModal').click(function() {
            $('#labelPreviewModal').addClass('hidden');
        });

        // Close modal when clicking outside of it
        $(window).click(function(event) {
            if (event.target == $('#labelPreviewModal')[0]) {
                $('#labelPreviewModal').addClass('hidden');
            }
        });
    });
</script>
{% endblock %}
