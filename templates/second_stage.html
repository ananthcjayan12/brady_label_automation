{% extends 'base.html' %}
{% load static %}

{% block title %}Second Stage{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-6 sm:px-6 lg:px-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Second Stage Label Generation</h1>
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:p-6">
            <form id="barcode-form" class="space-y-6" enctype="multipart/form-data">
                {% csrf_token %}
                <div>
                    <label for="logo-upload" class="block text-sm font-medium text-gray-700">Upload Logo (10x20) - Optional</label>
                    <input type="file" id="logo-upload" name="logo" accept="image/*" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    <p class="mt-1 text-sm text-gray-500">Leave empty to use default logo</p>
                </div>
                <div>
                    <label for="product-name" class="block text-sm font-medium text-gray-700">Product Name</label>
                    <input 
                        type="text" 
                        id="product-name" 
                        name="product_name" 
                        value="WaveTrac X1" 
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>
                <div>
                    <label for="model-input" class="block text-sm font-medium text-gray-700">Model</label>
                    <input 
                        type="text" 
                        id="model-input" 
                        name="model" 
                        value="0124-010" 
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>
                <div>
                    <label for="fcc-id-input" class="block text-sm font-medium text-gray-700">FCC ID</label>
                    <input 
                        type="text" 
                        id="fcc-id-input" 
                        name="fcc_id" 
                        value="2BFGFWTX1" 
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>
                <div>
                    <label for="barcode-input" class="block text-sm font-medium text-gray-700">Scan Barcode</label>
                    <div class="mt-1 relative rounded-md shadow-sm border border-gray-300 focus-within:ring-1 focus-within:ring-primary focus-within:border-primary">
                        <input type="text" name="barcode" id="barcode-input" class="block w-full pr-10 sm:text-sm rounded-md focus:outline-none" placeholder="Scan or enter barcode">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm2 2V5h1v1H5zM3 13a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1v-3zm2 2v-1h1v1H5zM13 3a1 1 0 00-1 1v3a1 1 0 001 1h3a1 1 0 001-1V4a1 1 0 00-1-1h-3zm1 2v1h1V5h-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="email-input" class="block text-sm font-medium text-gray-700">Email</label>
                    <input 
                        type="email" 
                        id="email-input" 
                        name="email" 
                        value="contact@waveinnova.com" 
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>
                <div>
                    <label for="fc-logo-upload" class="block text-sm font-medium text-gray-700">Upload FC Logo (10x10) - Optional</label>
                    <input type="file" id="fc-logo-upload" name="fc_logo" accept="image/*" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    <p class="mt-1 text-sm text-gray-500">Leave empty to use default FC logo</p>
                </div>
                <div>
                    <label for="font-size" class="block text-sm font-medium text-gray-700">Font Size</label>
                    <select id="font-size" name="font_size" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md">
                        <option value="4.5">4.5 (Default)</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="5.5">5.5</option>
                        <option value="6">6</option>
                    </select>
                </div>
                <div>
                    <button type="submit" id="generate-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Generate Label
                    </button>
                </div>
            </form>

            <div id="result-container" class="mt-8 hidden">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Generated Label</h2>
                <div class="bg-gray-100 p-4 rounded-md mb-4 border border-gray-300">
                    <p class="text-sm text-gray-600">Serial Number: <span id="serial-number" class="font-medium text-gray-900"></span></p>
                    <p class="text-sm text-gray-600 mt-2">IMEI: <span id="imei-number" class="font-medium text-gray-900"></span></p>
                </div>
                <div class="flex justify-end">
                    <button id="preview-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-secondary hover:bg-secondary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary">
                        Preview Label
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Label Preview -->
<div class="fixed z-10 inset-0 overflow-y-auto hidden" id="labelPreviewModal">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Label Preview</h3>
                        <div class="mt-2">
                            <embed id="labelPreviewEmbed" src="" type="application/pdf" width="100%" height="600px" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" id="closeModal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        let generatedPdfData = null;

        // Set default values if fields are empty
        if (!$('#model-input').val()) {
            $('#model-input').val('0124-010');
        }
        if (!$('#fcc-id-input').val()) {
            $('#fcc-id-input').val('2BFGFWTX1');
        }
        if (!$('#email-input').val()) {
            $('#email-input').val('contact@waveinnova.com');
        }

        $('#barcode-form').submit(function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            
            // Ensure default values are included even if not modified
            if (!formData.get('model')) {
                formData.set('model', '0124-010');
            }
            if (!formData.get('fcc_id')) {
                formData.set('fcc_id', '2BFGFWTX1');
            }
            if (!formData.get('email')) {
                formData.set('email', 'contact@waveinnova.com');
            }
            
            formData.append('stage', 'second-stage');

            $.ajax({
                url: '/process-barcode/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    if (data.success) {
                        $('#serial-number').text(data.serial_number);
                        $('#imei-number').text(data.imei_number);
                        $('#result-container').removeClass('hidden');
                        generatedPdfData = data.label_pdf;
                        
                        // Show PDF preview
                        $('#labelPreviewEmbed').attr('src', generatedPdfData);
                        $('#labelPreviewModal').removeClass('hidden');
                    } else {
                        alert('Error generating label: ' + data.error);
                    }
                },
                error: function() {
                    alert('An error occurred while processing the request.');
                }
            });
        });

        $('#print-btn').click(function() {
            var barcode = $('#barcode-input').val();
            $.post('/process-barcode/', {
                barcode: barcode,
                stage: 'second-stage',
                print: true,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }, function(data) {
                if (data.print_success) {
                    alert('Label printed successfully');
                } else {
                    alert('Error printing label: ' + data.print_message);
                }
            });
        });

        $('#preview-btn').click(function() {
            if (generatedPdfData) {
                $('#labelPreviewEmbed').attr('src', generatedPdfData);
                $('#labelPreviewModal').removeClass('hidden');
            } else {
                alert('Please generate a label first');
            }
        });

        $('#closeModal').click(function() {
            $('#labelPreviewModal').addClass('hidden');
        });

        // Close modal when clicking outside of it
        $(window).click(function(event) {
            if (event.target == $('#labelPreviewModal')[0]) {
                $('#labelPreviewModal').addClass('hidden');
            }
        });
    });
</script>
{% endblock %}
